<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" ng-app="poke">
<head>
    <meta name="viewport" content="width=device-width,height=device-height,inital-scale=1.0,maximum-scale=1.0,user-scalable=no;" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <style>
        * {
            padding: 0;
            margin: 0;
        }

        html, body {
            height: 100%;
        }

        .players {
            width: 100%;
            height: 10%;
            background-color: green;
        }

            .players li {
                float: left;
                height: 100%;
                width: 15%;
            }

        .options {
            width: 100%;
            height: 15%;
            background-color: yellow;
        }

        .pushes {
            width: 100%;
            height: 30%;
            background-color: blue;
        }

        .inhand {
            width: 100%;
            height: 45%;
            background-color: red;
        }

        .card, .card1 {
            text-align: center;
            background-color: white;
            border: 1px solid blue;
        }

        .choose {
            background-color: rgb(174, 245, 174);
        }

        .card {
            width: 80px;
            height: 120px;
            float: left;
        }

        .card1 {
            width: 80px;
            height: 120px;
            float: left;
        }

        .may{
            background-color:rgb(145, 242, 244);
            width:100%;
            bottom:0;
            position:fixed;
            height:70%;
        }
        .mayoption{
            width:100%;
            height:20%;
        }

        @media screen and (max-width: 360px) {
            .card {
                width: 40px;
                height: 60px;
                float: left;
            }

            .card1 {
                width: 40px;
                height: 60px;
                float: left;
            }
        }

        @media screen and (max-width: 320px) {
            .card {
                width: 30px;
                height: 40px;
                float: left;
            }

            .card1 {
                width: 30px;
                height: 40px;
                float: left;
            }
        }
    </style>
    <script src="Scripts/angular.js"></script>
</head>
<body ng-controller="body">
    <div class="players">
        <ul>
            <li ng-repeat="item in data.seats" id="{{item.UserId}}">
                {{item.UserName}}
                <span>{{item.IsOk}}</span>
            </li>
        </ul>
    </div>
    <div class="pushes">
        <div class="card" ng-repeat="item in data.lastPush" v="{{item.Value}}">{{item.Text}}</div>
    </div>
    <div class="inhand">
        <div class="card1" ng-repeat="item in data.you.inHand" v="{{item.Value}}" onclick="tg(this)">{{item.Text}}</div>
    </div>
    <div class="may" ng-if="data.showmay==true">
        <div class="mayoption" ng-repeat="item in data.may">
            {{item.Text}}
            <button onclick="push2server(this)" v="{{item.Value}}">choose</button>
        </div>
    </div>
    <div class="options">
        <script>
            document.write("w:" + window.screen.width + ",h:" + window.screen.height);
        </script>
        <div ng-if="data.gameState==0">
            <button ng-if="data.you.ready==false" ng-click="ready()">ready</button>
            <button ng-if="data.you.ready==true">wait</button>
        </div>
        <div ng-if="data.gameState==1">
            <div ng-if="data.you.inturn==true">
                <button ng-click="push()">push</button>
                <button>pass</button>
            </div>
            <div ng-if="data.you.inturn==false">
                <button>wait</button>
            </div>
        </div>
        <div ng-if="data.gameState==2">
            <button>finish</button>
        </div>
    </div>
    
    <script src="Scripts/jquery-2.1.1.js"></script>
    <script src="Scripts/jquery.signalR-2.1.0.js"></script>
    <script src="http://localhost:1432/signalr/hubs"></script>
    <script src="app/rules.js"></script>
    <script>
        var state = {
            WaitForUserReady: 0,
            WaitForUserSay: 1,
            Finish: 2
        };
        var game = {
            uid: "",
            tabid: "",
            owner:"",
            seats: [],
            you: {
                inHand: [],
                ready: false,
                inturn: false
            },
            lastPush: [],
            lastBigUser: "",
            nowSpeaker: "",
            gameState: 1,
            showmay: false,
            may: [],
            realpush:[]
        };
        var app = angular.module("poke", []);

        app.controller("body", function ($scope) {
            var uid = localStorage.getItem("uid");
            var tabid = localStorage.getItem("tabid");
            if (uid == null) {
                location.href = "login.html";
            }
            if (tabid == null) {
                location.href = "list.html";
            }
            game.uid = uid;
            game.tabid = tabid;
            var proxy=connectToServer($scope);
            $scope.update = function (data) {
                $scope.data = data;
                $scope.$apply();
            };

            $scope.ready = function() {
                proxy.server.ready(tabid,uid);
            };

            $scope.push = function() {
                var cards = $(".inhand .choose");
                

                pushCards($scope, proxy, cards);
            };
        });

        

        function update(ctrl, data) {
            var obj = document.querySelector("[ng-controller=" + ctrl + "]");
            var ele = angular.element(obj);
            ele.scope().update(data);
        }
        function connectToServer($scope) {
            var url = "http://localhost:1432/";
            $.connection.hub.qs = { "tab": game.tabid, "uid": game.uid };

            var proxy = $.connection.tabHub;
            game.proxy = proxy;
            $.connection.hub.error(function (error) {
                console.log('SignalR error: ' + error);
            });
            $.connection.hub.url = url + "signalr";

            var client = $.connection.tabHub.client;
            setClientFunc(client,$scope);
            $.connection.hub.start();

            return proxy;
        }

        function setClientFunc(client, $scope) {
            client.test = function(txt) {
                console.log(txt);
            };
            client.err = function (msg) {
                console.log(msg);
            };

            client.refreshInfo = function (tab) {
                fillData(tab);
                $scope.update(game);
            };

            client.refreshUsers = function(users) {
                fillUser(users);
                $scope.update(game);
            };
            client.refreshYou = function (you) {
                fillyou(you);
                $scope.update(game);
            };
        }

        function fillData(tab) {
            game.lastPush = tab.LastHand;
            game.gameState = tab.State;
            game.lastBigUser = tab.BigUser;
            game.nowSpeaker = tab.WaitUser;
            game.owner = tab.OwnerId;
        }

        function fillUser(users) {
            game.seats = users;
        }

        function fillyou(you) {
            
            game.you.inHand = you.InHand;
            game.you.ready = you.Ready;
            game.you.inturn = you.Turn;
        }
        function tg(item) {
            if (game.you.inturn) {
                $(item).toggleClass("choose");
            }
        }

        function pushCards($scope, proxy,cards) {
            var arr = cards.map(function () { return parseInt($(this).attr("v")); }).get();
            game.realpush = arr;
            var may = rules.may(arr);
            var last = game.lastPush.map(function (item) { return item.Value; });
            if (may.length == 1) {
                if (game.lastPush != null && game.lastPush.length>0) {
                    
                    if (rules.isBiger(last, may[0],arr)) {
                        send2server(may[0], arr);
                    }
                } else {
                    send2server(may[0], arr);
                }
                return;
            }
            
            var bigmay = [];
            if (game.lastPush == null || game.lastPush.length==0) {
                bigmay = may;
            } else {
                for (var i = 0; i < may.length; i++) {
                    if (rules.isBiger(last, may[i],arr)) {
                        bigmay.push(may[i]);
                    }
                }
            }

            if (bigmay.length > 0) {
                game.showmay = true;
                game.may = bigmay.map(function(item) {
                    return {
                        Value: item,
                        Text: cards2str(item)
                    };
                });
            }

            //$scope.update(game);
        }

        function cards2str(arr) {
            return arr.join(',').replace(/11/g, "J").replace(/12/g, "Q").replace(/13/g, "K").replace(/14/g, "A");
        }

        function push2server(obj) {
            var real = game.realpush;
            var v = eval($(obj).attr("v"));
            send2server(v, real);
            game.showmay = false;
            update("body", game);
        }

        function send2server(arr, real) {
            
            $.connection.tabHub.server.push(game.tabid, game.uid, arr, real);
        }
    </script>
</body>
</html>
